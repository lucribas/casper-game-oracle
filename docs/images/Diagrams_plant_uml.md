


# Introduction

1. The **Game** requests a **challenge** to generates a random number and pay a *REWARD_CHALLENGE* to **reward** the Oracle participants.
2. Each **challenge** have a unique identifier ***C*** generated by the OracleCoordinatorContract;
4. The **challenge** should be taken by all **Oracles** who have been registered and active;
5. **Oracle answer timeout penalty:** If a **registered and active Oracle** does not respond before a predetermined *TIMEOUT_BLOCKS* number of blocks, a penalty tax of *TIMEOUT_FINE* will be deducted from their funds;
6. **Oracle misbehavior seized funds:** If a **registered and active Oracle** answers a challenge with a fake proof or an erroneous *hash/k/pk/rnd*, their funds will be seized, and they will be banished in future challenges.
7. One **new Oracle** can request **registration** and should submits a **funding** of *ORACLE_FUND* caspers;
8. One **registed Oracle** can request **activation** when ready to participate of challenges;
9. One **registed Oracle** Oracle can request **inactivation** if needed;
10. One **registed Oracle** can request **withdraw** their profits anytime;
11. One **registed Oracle** can request **unregister** and **withdraw** their funds;
12. One **inactive and registed Oracle** may **participate** in the challenge, for **testing purposes**, but its participation will have no influence on the final random result, have no reward credits or any penalty issued.
14. The **seized funds** due misbehavior or penalty are credited to the ***DEV_ADDRESS* developers account**. Otherwise, the sharing of seized values ​​among the participants could encourage collusion attacks.





# Oracle Registration

1. First Oracle is registered when contract is deployed




# Events, Messages

```plantuml
@startuml
title **Oracles** should subscribe to the Casper Network to receive OracleCoodinatorContract events.

activate OracleCoordinatorContract
activate CasperNetwork
OracleCoordinatorContract -> OracleCoordinatorContract : deploy
deactivate OracleCoordinatorContract
activate Oracle_01
Oracle_01 -> CasperNetwork : subscribe to events
deactivate Oracle_01
activate Oracle_02
Oracle_02 -> CasperNetwork : subscribe to events
deactivate Oracle_02
activate Oracle_03
Oracle_03 -> CasperNetwork : subscribe to events
deactivate Oracle_03
activate Oracle_04
Oracle_04 -> CasperNetwork : subscribe to events
deactivate Oracle_04
activate OracleCoordinatorContract
OracleCoordinatorContract -> CasperNetwork : emit events

@enduml
```


```plantuml
@startuml
title **Game** can subscribe to the Casper Network to receive OracleCoodinatorContract events.

activate OracleCoordinatorContract
activate CasperNetwork
OracleCoordinatorContract -> OracleCoordinatorContract : deploy
deactivate OracleCoordinatorContract
activate Game
Game -> CasperNetwork : subscribe to events
deactivate Game
activate OracleCoordinatorContract
OracleCoordinatorContract -> CasperNetwork : emit events
@enduml
```

```plantuml
@startuml
title **Game** can register a Game contract callback to receive the challenge result
activate Game
activate OracleCoordinatorContract
Game -> OracleCoordinatorContract : getRndWithCallback and pay tax
@enduml
```

# Game Oracle Use Case


```plantuml
@startuml
title Round 1: Game requests a random number, and the Coordinator sends a message to all Oracles.
activate Game
activate OracleCoordinatorContract
activate CasperNetwork
activate Oracle_01..N
Oracle_01..N -> CasperNetwork : subscribe to events
Game -> OracleCoordinatorContract : getRnd and pay tax
Game -> OracleCoordinatorContract : OR\ngetRndWithCallback and pay tax
OracleCoordinatorContract -> CasperNetwork : emits a event 'getRnd(C)'\nasking Oracles to compute a random number\nfor challenge C
Oracle_01..N <- CasperNetwork : receive a event
@enduml
```




```plantuml
@startuml
title Round 2: Each Oracle offers a random number, a hash, and a proof, while the Coordinator checks everything.
activate Oracle_01
activate Oracle_02
activate Oracle_03
activate Oracle_04
Oracle_01 -> Oracle_01 : generates RND1\ngenerates k1,pk1\ncomputes (HASH1,ρ1)
Oracle_02 -> Oracle_02 : generates RND2\ngenerates k2,pk2\ncomputes (HASH2,ρ2)
Oracle_03 -> Oracle_03 : generates RND3\ngenerates k3,pk3\ncomputes (HASH3,ρ3)
Oracle_04 -> Oracle_04 : generates RND4\ngenerates k4,pk4\ncomputes (HASH4,ρ4)
Oracle_01 -> OracleCoordinatorContract : sends (pk1, HASH1, ρ1)
OracleCoordinatorContract -> OracleCoordinatorContract : check proofs
Oracle_02 -> OracleCoordinatorContract : sends (pk2, HASH2, ρ2)
OracleCoordinatorContract -> OracleCoordinatorContract : check proofs
Oracle_03 -> OracleCoordinatorContract : sends (pk3, HASH3, ρ3)
OracleCoordinatorContract -> OracleCoordinatorContract : check proofs
Oracle_04 -> OracleCoordinatorContract : sends (pk4, HASH4, ρ4)
OracleCoordinatorContract -> OracleCoordinatorContract : check proofs
@enduml
```

```plantuml
@startuml
title Round 3: Coordinator requests that each Oracles reveal secrets and then generates the final random number.

activate OracleCoordinatorContract
OracleCoordinatorContract -> OracleCoordinatorContract : if enough oracles
activate CasperNetwork
OracleCoordinatorContract -> CasperNetwork : emit 'publish secrets'
activate Oracle_01
Oracle_01 -> OracleCoordinatorContract : answer (k1, RND1)
OracleCoordinatorContract -> OracleCoordinatorContract : check secrets and correct behavior
deactivate Oracle_01
activate Oracle_02
Oracle_02 -> OracleCoordinatorContract : answer (k2, RND2)
OracleCoordinatorContract -> OracleCoordinatorContract : check secrets and correct behavior
deactivate Oracle_02
activate Oracle_03
Oracle_03 -> OracleCoordinatorContract : answer (k3, RND3)
OracleCoordinatorContract -> OracleCoordinatorContract : check secrets and correct behavior
deactivate Oracle_03
activate Oracle_04
Oracle_04 -> OracleCoordinatorContract : answer (k4, RND4)
OracleCoordinatorContract -> OracleCoordinatorContract : check secrets and correct behavior
deactivate Oracle_04
OracleCoordinatorContract -> OracleCoordinatorContract : wait TIMEOUT blocks for all answers
OracleCoordinatorContract -> OracleCoordinatorContract : computes the final random number\nof correct oracle behaviors:\n RND = f(RND1,RND2,RND3,..)
@enduml
```

```plantuml
@startuml
title Round 4: Coordinator sends the Random Number to Casper Network and to Game contract callback function if registered.
activate OracleCoordinatorContract
activate CasperNetwork
activate Game_Contract
OracleCoordinatorContract -> CasperNetwork : emit message RND
OracleCoordinatorContract -> Game_Contract: if has callback then\n sends RND
@enduml
```

```plantuml
@startuml
title Round 5: For correct behavior each Oracle who participate earn T percent of the tax collected from the coordinator.
OracleCoordinatorContract -> OracleCoordinatorContract : for each Orace\n  if right behavior then\n    credit T*tax/N to oracle
activate CasperNetwork
OracleCoordinatorContract -> CasperNetwork : emit 'Oracle credits are available'
activate Oracle_01
Oracle_01 -> OracleCoordinatorContract : request transfer credits
deactivate Oracle_01
activate Oracle_02
Oracle_02 -> OracleCoordinatorContract : request transfer credits
deactivate Oracle_02
activate Oracle_03
Oracle_03 -> OracleCoordinatorContract : request transfer credits
deactivate Oracle_03
activate Oracle_04
Oracle_04 -> OracleCoordinatorContract : request transfer credits
deactivate Oracle_04
@enduml
```

```plantuml
@startuml
title Round 6: For misbehavior each Oracle is punished with seizure of their funds.
OracleCoordinatorContract -> OracleCoordinatorContract : for each Oracle\n  if misbehavior then\n    seizure their funds
activate CasperNetwork
OracleCoordinatorContract -> CasperNetwork : emit 'Oracle X's funds have been seized\n due to their misbehavior on challenge C.'
@enduml
```

